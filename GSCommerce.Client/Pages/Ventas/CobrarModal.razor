@using GSCommerce.Client.Models
@using GSCommerce.Client.Services
@using System.Linq
@using System
@inject TipoPagoVentaService TipoPagoVentaService
@inject NotaCreditoService NotaCreditoService


<div class="modal fade @(Mostrar ? "show d-block" : "")" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Cobrar Venta</h5>
                <button type="button" class="btn-close" @onclick="Cerrar" aria-label="Close"></button>
            </div>

            <div class="modal-body">

                <div class="mb-3">
                    <label>Forma de Pago:</label>
                    <select class="form-select" @bind="idTipoPagoSeleccionado" @bind:after="TipoPagoChanged">
                        @foreach (var tp in tiposPago)
                        {
                            <option value="@tp.IdTipoPagoVenta">@tp.Descripcion</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label>Monto (@Simbolo.Trim()):</label>
                    <input type="number" class="form-control" @bind="montoPago" min="0" step="0.01" max="@MaxMontoPago" @onkeydown="HandleMontoKeyDown" />
                </div>
                @if (idTipoPagoSeleccionado == 8)
                {
                    <div class="mb-3">
                        <label>
                            Documento de Referencia (Serie-Número):
                            @if (notasCreditoDisponibles.Any())
                            {
                                <span class="text-muted">(@string.Join(", ", notasCreditoDisponibles.Select(n => $"{n.Serie}-{n.Numero:D8}")))</span>
                            }
                        </label>
                        <div class="input-group">
                            <input class="form-control" @bind="documentoReferencia" list="listaNotasCredito" />
                            <datalist id="listaNotasCredito">
                                @foreach (var nc in notasCreditoDisponibles)
                                {
                                    <option value="@($"{nc.Serie}-{nc.Numero:D8}")"></option>
                                }
                            </datalist>
                            <button class="btn btn-outline-secondary" @onclick="BuscarNotaCredito">Buscar</button>
                        </div>
                        @if (notaCreditoSeleccionada != null)
                        {
                            <div class="form-text">Monto disponible: @notaCreditoSeleccionada.Total.ToString("N2")</div>
                        }
                    </div>
                }
                @if (TipoPagoSeleccionado?.Tipo == "Efectivo")
                {
                    <div class="mb-3">
                        <label>Vuelto:</label>
                        <input class="form-control" value="@VueltoCalculado.ToString("N2")" readonly />
                    </div>
                }
                @if (TipoPagoSeleccionado?.Tipo == "Tarjeta")
                {
                    <div class="mb-3">
                        <label>4 últimos dígitos de la tarjeta:</label>
                        <input class="form-control" maxlength="4" @bind="codigoVerificacion" />
                    </div>
                }
                @if (TipoPagoSeleccionado?.Descripcion.ToUpper().Contains("YAPE") == true)
                {
                    <div class="mb-3">
                        <label>3 dígitos de verificación:</label>
                        <input class="form-control" maxlength="3" @bind="codigoVerificacion" />
                    </div>
                }
                <div class="text-end mb-2">
                    <button class="btn btn-secondary me-2" @onclick="AgregarPago">Agregar Pago</button>
                </div>

                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Forma</th>
                            <th>Monto</th>
                            <th>Cod. Verif.</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var pago in pagos)
                        {
                            <tr>
                                <td>@pago.FormaPago</td>
                                <td>@Simbolo@pago.Monto.ToString("N2")</td>
                                <td>@pago.CodigoVerificacion</td>
                                <td><button class="btn btn-danger btn-sm" @onclick="() => EliminarPago(pago)">X</button></td>
                            </tr>
                        }
                    </tbody>
                </table>
                @if (VueltoCalculado > 0)
                {
                    <div class="text-end text-success">
                        <h5>Vuelto: @Simbolo@VueltoCalculado.ToString("N2")</h5>
                    </div>
                }
                <div class="text-end">
                    <h5>Total Pagado: @Simbolo@TotalPagado.ToString("N2")</h5>
                    <h5>Falta: @Simbolo@(Math.Max(0, MontoTotal - TotalPagado).ToString("N2"))</h5>
                </div>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-success" @onclick="ConfirmarPago" disabled="@(!PuedeConfirmar)">Confirmar Pago</button>
                <button type="button" class="btn btn-secondary" @onclick="Cerrar">Cancelar</button>
            </div>

        </div>
    </div>
</div>

@code {
    [Parameter] public decimal MontoTotal { get; set; }
    [Parameter] public EventCallback<List<DetallePagoDTO>> OnConfirmado { get; set; }
    [Parameter] public EventCallback OnCancelado { get; set; }
    [Parameter] public string MonedaAlmacen { get; set; } = "PEN";
    [Parameter] public string? TipoDocumento { get; set; }
    [Parameter] public int IdAlmacen { get; set; }

    public bool Mostrar { get; set; }

    private List<TipoPagoVentaDTO> tiposPago = new();
    private int idTipoPagoSeleccionado;
    private decimal montoPago;
    private string? codigoVerificacion;
    private List<DetallePagoDTO> pagos = new();
    private string? documentoReferencia;
    private NotaCreditoConsultaDTO? notaCreditoSeleccionada;
    private List<NotaCreditoConsultaDTO> notasCreditoDisponibles = new();

    private string Simbolo => MonedaAlmacen == "USD" ? "$ " : "S/ ";

    private TipoPagoVentaDTO? TipoPagoSeleccionado => tiposPago.FirstOrDefault(t => t.IdTipoPagoVenta == idTipoPagoSeleccionado);

    private decimal TotalPagado => pagos.Sum(p => p.Monto);
    private decimal MontoRestante => Math.Max(0, MontoTotal - TotalPagado);

    private bool EsTarjetaOYape =>
        TipoPagoSeleccionado?.Descripcion?.Contains("Tarjeta", StringComparison.OrdinalIgnoreCase) == true ||
        TipoPagoSeleccionado?.Descripcion?.Contains("Yape", StringComparison.OrdinalIgnoreCase) == true;

    private decimal? MaxMontoPago => EsTarjetaOYape ? MontoRestante : null;

    private bool EsPagoEfectivo(int idTipoPagoVenta)
    {
        var tipoPago = tiposPago.FirstOrDefault(t => t.IdTipoPagoVenta == idTipoPagoVenta);

        if (tipoPago != null)
        {
            if (string.Equals(tipoPago.Tipo, "Efectivo", StringComparison.OrdinalIgnoreCase))
            {
                return true;
            }

            if (!string.IsNullOrWhiteSpace(tipoPago.Descripcion) &&
                tipoPago.Descripcion.Contains("Efectivo", StringComparison.OrdinalIgnoreCase))
            {
                return true;
            }
        }

        return idTipoPagoVenta == 2 || idTipoPagoVenta == 3;
    }

    private decimal VueltoCalculado
    {
        get
        {
            var totalEfectivo = pagos.Where(p => EsPagoEfectivo(p.IdTipoPagoVenta)).Sum(p => p.Monto);

            if (totalEfectivo <= 0)
            {
                return 0;
            }

            var totalNoEfectivo = pagos.Where(p => !EsPagoEfectivo(p.IdTipoPagoVenta)).Sum(p => p.Monto);
            var saldoCubiertoConEfectivo = Math.Max(0, MontoTotal - totalNoEfectivo);

            return Math.Max(0, totalEfectivo - saldoCubiertoConEfectivo);
        }
    }

    private bool PuedeConfirmar => TotalPagado >= MontoTotal;

    protected override async Task OnParametersSetAsync()
    {
        tiposPago = await TipoPagoVentaService.ObtenerTodosAsync();

        if (!string.IsNullOrWhiteSpace(TipoDocumento) && TipoDocumento.Equals("TICKET", StringComparison.OrdinalIgnoreCase))
        {
            tiposPago = tiposPago
                .Where(t => t.Descripcion == "Efectivo Soles" || t.Descripcion == "Efectivo Dólares" || t.Descripcion == "N.C. - Nota de Crédito")
                .ToList();
        }

        else if (MonedaAlmacen != "USD")
        {
            tiposPago = tiposPago.Where(t => t.Descripcion != "Efectivo Dólares").ToList();
        }
        idTipoPagoSeleccionado = tiposPago.FirstOrDefault()?.IdTipoPagoVenta ?? 0;

        await TipoPagoChanged();
    }

    public async Task Abrir()
    {
        pagos.Clear();
        montoPago = MontoTotal;
        codigoVerificacion = null;
        idTipoPagoSeleccionado = tiposPago.FirstOrDefault()?.IdTipoPagoVenta ?? 0;
        await TipoPagoChanged();
        Mostrar = true;
        await InvokeAsync(StateHasChanged);
    }

    private void Cerrar()
    {
        Mostrar = false;
        OnCancelado.InvokeAsync();
    }

    private void AgregarPago()
    {
        if (montoPago > 0)
        {
            if (EsTarjetaOYape && montoPago > MontoRestante)
            {
                montoPago = MontoRestante;
            }

            if (montoPago <= 0)
            {
                return;
            }

            if (idTipoPagoSeleccionado == 8 && notaCreditoSeleccionada == null)
            {
                return;
            }

            var nuevoPago = new DetallePagoDTO
            {
                FormaPago = TipoPagoSeleccionado?.Descripcion ?? string.Empty,
                IdTipoPagoVenta = idTipoPagoSeleccionado,
                Monto = montoPago,
                CodigoVerificacion = codigoVerificacion,
                Datos = codigoVerificacion
            };

            if (idTipoPagoSeleccionado == 3)
            {
                nuevoPago.Dolares = montoPago;
            }
            else
            {
                nuevoPago.Soles = montoPago;
            }

            pagos.Add(nuevoPago);

            montoPago = 0;
            codigoVerificacion = null;
            idTipoPagoSeleccionado = tiposPago.FirstOrDefault()?.IdTipoPagoVenta ?? 0;
        }
    }

    private void HandleMontoKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AgregarPago();
        }
    }

    private void EliminarPago(DetallePagoDTO pago)
    {
        pagos.Remove(pago);
    }

    private async Task TipoPagoChanged()
    {
        if (idTipoPagoSeleccionado == 8)
        {
            await CargarNotasCredito();
        }
        else
        {
            notasCreditoDisponibles.Clear();
        }

        if (EsTarjetaOYape)
        {
            var restante = MontoRestante;
            if (montoPago > restante)
            {
                montoPago = restante;
            }
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task CargarNotasCredito()
    {
        var notas = await NotaCreditoService.ObtenerNotasAsync(DateTime.Today.AddYears(-1), DateTime.Today, null, IdAlmacen);
        notasCreditoDisponibles = notas
            .Where(n => n.Empleada != true && string.IsNullOrEmpty(n.Comprobante))
            .ToList();
        await InvokeAsync(StateHasChanged);
    }

    private async Task BuscarNotaCredito()
    {
        notaCreditoSeleccionada = null;
        codigoVerificacion = null;
        if (string.IsNullOrWhiteSpace(documentoReferencia)) return;
        var partes = documentoReferencia.Split('-');
        if (partes.Length != 2) return;
        if (!int.TryParse(partes[1], out var numero)) return;

        try
        {
            var nota = await NotaCreditoService.BuscarPorDocumentoAsync(partes[0], numero);
            if (nota != null && nota.Empleada != true && string.IsNullOrEmpty(nota.Comprobante))
            {
                notaCreditoSeleccionada = nota;
                var restante = MontoTotal - TotalPagado;
                montoPago = Math.Min(nota.Total, restante > 0 ? restante : 0);
                codigoVerificacion = documentoReferencia;
            }
        }
        catch { }
    }

    private async Task ConfirmarPago()
    {
        // Calculamos el vuelto total antes de enviar los pagos
        var vuelto = VueltoCalculado;
        var pagoEfectivo = pagos.FirstOrDefault(p => EsPagoEfectivo(p.IdTipoPagoVenta));

        if (pagoEfectivo != null)
        {
            pagoEfectivo.Vuelto = vuelto;
        }

        Mostrar = false;
        await OnConfirmado.InvokeAsync(pagos);
    }
}