@page "/ordenes-compra"
@**@
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.WebUtilities
@using GSCommerce.Client.Models
@using GSCommerce.Client.Services
@using System.Linq
@using System
@inject OrdenCompraService ocService
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject HttpClient Http

<h3>Ordenes de Compra</h3>

<div class="row mb-3">
    <div class="col-md-3">
        <label>Desde:</label>
        <input type="date" class="form-control" @bind-value="desde" @bind-value:event="oninput" />
    </div>
    <div class="col-md-3">
        <label>Hasta:</label>
        <input type="date" class="form-control" @bind-value="hasta" @bind-value:event="oninput" />
    </div>
    <div class="col-md-4">
        <label>Proveedor:</label>
        <div class="input-group">
            <input class="form-control" value="@nombreProveedor" readonly />
            <button class="btn btn-secondary" @onclick="() => mostrarProveedorModal = true"><i class="bi bi-search"></i> Buscar</button>
            <button class="btn btn-outline-secondary" @onclick="LimpiarProveedor">X</button>
        </div>
    </div>
    <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100" @onclick="Buscar"><i class="bi bi-search"></i> Buscar</button>
    </div>
</div>

<div class="mb-2 text-end">
    <button class="btn btn-outline-success me-2" @onclick="ExportarOrdenesExcel">Exportar Excel</button>
    <button class="btn btn-success" @onclick="Nuevo">+ Nueva OC</button>
</div>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>Fecha</th>
            <th>Control</th>
            <th>Proveedor</th>
            <th>Total</th>
            <th>Estado</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @if (ordenesPaginated.Any())
        {
            foreach (var o in ordenesPaginated)
            {
                <tr>
                    <td>@o.FechaOc.ToString("dd/MM/yyyy")</td>
                    <td>@o.Glosa</td>
                    <td>@o.Nombre</td>
                    <td>@o.ImporteTotal.ToString("C")</td>
                    <td>@o.Estado</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" @onclick="() => VerDetalle(o.IdOc)">Ver</button>
                        <button class="btn btn-sm btn-warning me-1" @onclick="() => Editar(o.IdOc)" disabled="@(!PuedeEditar(o))">Editar</button>
                        <button class="btn btn-sm btn-secondary me-1" @onclick="() => GenerarIngreso(o.IdOc)" disabled="@(!PuedeGenerarIngreso(o))">Ingreso</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => Anular(o.IdOc)" disabled="@(!PuedeAnular(o))">Anular</button>
                    </td>
                </tr>
            }
        }
        else
        {
            <tr><td colspan="6" class="text-center">Sin registros</td></tr>
        }
    </tbody>
</table>

<div class="d-flex justify-content-between">
    <button class="btn btn-secondary" @onclick="PrevPageOc" disabled="@(currentPageOc <= 1)">Anterior</button>
    <span>Página @currentPageOc de @totalPagesOc</span>
    <button class="btn btn-secondary" @onclick="NextPageOc" disabled="@(currentPageOc >= totalPagesOc)">Siguiente</button>
</div>

<div class="mt-2 text-end"><strong>Total: @totalOrdenes.ToString("C")</strong></div>

<h3 class="mt-5">Pago Proveedores</h3>

<div class="mb-2 text-end">
    <button class="btn btn-outline-success" @onclick="ExportarPagosExcel">Exportar Excel</button>
</div>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Fecha</th>
            <th>Almacén</th>
            <th>Proveedor</th>
            <th>Total</th>
            <th>Estado</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @if (pagosPaginated.Any())
        {
            foreach (var o in pagosPaginated)
            {
                <tr>
                    <td>@o.FechaOc.ToString("dd/MM/yyyy")</td>
                    <td>@o.Almacen</td>
                    <td>@o.Nombre</td>
                    <td>@o.ImporteTotal.ToString("C")</td>
                    <td>@o.Estado</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" @onclick="() => VerDetalle(o.IdOc)">Ver</button>
                        <button class="btn btn-sm btn-secondary" @onclick="() => VerFotoPago(o)">Foto</button>
                    </td>
                </tr>
            }
        }
        else
        {
            <tr><td colspan="6" class="text-center">Sin registros</td></tr>
        }
    </tbody>
</table>

<div class="d-flex justify-content-between">
    <button class="btn btn-secondary" @onclick="PrevPagePagos" disabled="@(currentPagePagos <= 1)">Anterior</button>
    <span>Página @currentPagePagos de @totalPagesPagos</span>
    <button class="btn btn-secondary" @onclick="NextPagePagos" disabled="@(currentPagePagos >= totalPagesPagos)">Siguiente</button>
</div>

<div class="mt-2 text-end"><strong>Total: @totalPagos.ToString("C")</strong></div>

@if (showPhotoModal)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Foto</h5>
                    <button type="button" class="btn-close" @onclick="ClosePhotoModal"></button>
                </div>
                <div class="modal-body text-center">
                    @if (!string.IsNullOrEmpty(photoUrl))
                    {
                        <img src="@photoUrl" alt="Foto" class="img-fluid img-thumbnail" style="max-width:300px;max-height:300px;" />
                    }
                    else
                    {
                        <p>No hay foto disponible.</p>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="ClosePhotoModal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

<ProveedorBuscarModal Mostrar="mostrarProveedorModal" MostrarChanged="(v) => mostrarProveedorModal = v" OnSeleccionado="SeleccionarProveedor" />

@code {
    private DateTime desde = DateTime.Today;
    private DateTime hasta = DateTime.Today;
    private List<OrdenCompraConsultaDTO> ordenes = new();
    private bool mostrarProveedorModal = false;
    private int? idProveedor;
    private string nombreProveedor = string.Empty;

    private List<OrdenCompraConsultaDTO> pagos = new();

    private bool showPhotoModal = false;
    private string? photoUrl;

    private int pageSizeOc = 10;
    private int currentPageOc = 1;
    private int totalPagesOc => (int)Math.Ceiling((double)ordenes.Count / pageSizeOc);
    private IEnumerable<OrdenCompraConsultaDTO> ordenesPaginated => ordenes.Skip((currentPageOc - 1) * pageSizeOc).Take(pageSizeOc);

    private int pageSizePagos = 10;
    private int currentPagePagos = 1;
    private int totalPagesPagos => (int)Math.Ceiling((double)pagos.Count / pageSizePagos);
    private IEnumerable<OrdenCompraConsultaDTO> pagosPaginated => pagos.Skip((currentPagePagos - 1) * pageSizePagos).Take(pageSizePagos);

    private decimal totalOrdenes => ordenes.Sum(o => o.ImporteTotal);
    private decimal totalPagos => pagos.Sum(o => o.ImporteTotal);

    private HashSet<int> ingresoEnProceso = new();
    private HashSet<int> anulacionEnProceso = new();
    private DateTime desdeOc, hastaOc, desdePago, hastaPago;

    protected override async Task OnInitializedAsync()
    {
        // Leer parámetros de la URL para mantener el estado de búsqueda
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        
        if (query.TryGetValue("desde", out var desdeParam) && DateTime.TryParse(desdeParam, out var desdeDate))
            desde = desdeDate;
            
        if (query.TryGetValue("hasta", out var hastaParam) && DateTime.TryParse(hastaParam, out var hastaDate))
            hasta = hastaDate;
            
        if (query.TryGetValue("proveedor", out var proveedorParam) && int.TryParse(proveedorParam, out var proveedorId))
            idProveedor = proveedorId;
            
        if (query.TryGetValue("nombreProveedor", out var nombreParam))
            nombreProveedor = nombreParam;

        desdeOc = desdePago = desde;
        hastaOc = hastaPago = hasta;

        await Task.WhenAll(Buscar(), BuscarPagos());
    }

    private async Task Buscar()
    {
        // Actualizar la URL para mantener el estado de búsqueda
        ActualizarUrl();
        
        var lista = await ocService.ListarAsync(desde, hasta, idProveedor);
        ordenes = lista.Where(o => !o.NumeroOc.StartsWith("PP-", StringComparison.OrdinalIgnoreCase)).ToList();
        NormalizarEstados(ordenes);
        currentPageOc = 1;
        ingresoEnProceso.Clear();
        anulacionEnProceso.Clear();
    }

    private void ActualizarUrl()
    {
        var queryParams = new List<string>();
        
        if (desde != DateTime.Today)
            queryParams.Add($"desde={desde:yyyy-MM-dd}");
            
        if (hasta != DateTime.Today)
            queryParams.Add($"hasta={hasta:yyyy-MM-dd}");
            
        if (idProveedor.HasValue)
        {
            queryParams.Add($"proveedor={idProveedor.Value}");
            queryParams.Add($"nombreProveedor={Uri.EscapeDataString(nombreProveedor)}");
        }
        
        var queryString = queryParams.Count > 0 ? "?" + string.Join("&", queryParams) : "";
        var newUrl = $"/ordenes-compra{queryString}";
        
        Nav.NavigateTo(newUrl, replace: true);
    }

    private async Task BuscarPagos()
    {
        var lista = await ocService.ListarAsync(desde, hasta, idProveedor);
        pagos = lista.Where(o => o.NumeroOc.StartsWith("PP-", StringComparison.OrdinalIgnoreCase)).ToList();
        NormalizarEstados(pagos);
        currentPagePagos = 1;
    }

    private async Task ExportarOrdenesExcel()
    {
        if (!ordenes.Any())
            return;

        var headers = new[] { "Fecha", "Número", "Proveedor", "Total", "Estado" };
        var rows = ordenes.Select(o => new object[]
        {
            o.FechaOc.ToString("dd/MM/yyyy"),
            o.NumeroOc,
            o.Nombre,
            o.ImporteTotal,
            o.Estado ?? string.Empty
        }).ToArray();

        await JS.InvokeVoidAsync("exportToExcel", headers, rows, $"OrdenesCompra_{desdeOc:yyyyMMdd}_{hastaOc:yyyyMMdd}");
    }

    private async Task ExportarPagosExcel()
    {
        if (!pagos.Any())
            return;

        var headers = new[] { "Fecha", "Almacén", "Proveedor", "Total", "Estado" };
        var rows = pagos.Select(o => new object[]
        {
            o.FechaOc.ToString("dd/MM/yyyy"),
            o.Almacen ?? string.Empty,
            o.Nombre,
            o.ImporteTotal,
            o.Estado ?? string.Empty
        }).ToArray();

        await JS.InvokeVoidAsync("exportToExcel", headers, rows, $"PagosProveedores_{desdePago:yyyyMMdd}_{hastaPago:yyyyMMdd}");
    }

    private void Nuevo() => Nav.NavigateTo("/ordenes-compra/nuevo");

    private void VerDetalle(int id) => Nav.NavigateTo($"/ordenes-compra/{id}");

    private void Editar(int id) => Nav.NavigateTo($"/ordenes-compra/editar/{id}");

    private async Task GenerarIngreso(int id)
    {
        if (!ingresoEnProceso.Add(id))
            return;

        try
        {
            var resultado = await ocService.GenerarIngresoAsync(id, 1009);
            if (resultado.Success)
            {
                await JS.InvokeVoidAsync("alert", "Ingreso generado");
                var orden = ordenes.FirstOrDefault(o => o.IdOc == id);
                if (orden != null)
                {
                    orden.Estado = NormalizarEstado(resultado.Estado) ?? "INGRESADO";
                }
            }
            else
            {
                await JS.InvokeVoidAsync("alert", resultado.ErrorMessage ?? "No se pudo generar ingreso");
            }
        }
        finally
        {
            ingresoEnProceso.Remove(id);
        }
    }

    private async Task Anular(int id)
    {
        if (!anulacionEnProceso.Add(id))
            return;

        try
        {
            var resultado = await ocService.AnularAsync(id);
            if (resultado.Success)
            {
                await JS.InvokeVoidAsync("alert", resultado.Message ?? "Orden anulada");
                var orden = ordenes.FirstOrDefault(o => o.IdOc == id);
                if (orden != null)
                {
                    orden.Estado = "ANULADO";
                    orden.FechaAnulado = DateTime.Now;
                }
            }
            else
            {
                await JS.InvokeVoidAsync("alert", resultado.Message ?? "No se pudo anular la orden");
            }
        }
        finally
        {
            anulacionEnProceso.Remove(id);
        }
    }

    private static bool PuedeEditar(OrdenCompraConsultaDTO o) =>
        string.IsNullOrEmpty(o.Estado) || o.Estado.Equals("PENDIENTE", StringComparison.OrdinalIgnoreCase);

    private bool PuedeGenerarIngreso(OrdenCompraConsultaDTO o) =>
        PuedeEditar(o) && !ingresoEnProceso.Contains(o.IdOc);

    private bool PuedeAnular(OrdenCompraConsultaDTO o)
    {
        if (anulacionEnProceso.Contains(o.IdOc))
        {
            return false;
        }

        return string.Equals(NormalizarEstado(o.Estado), "INGRESADO", StringComparison.OrdinalIgnoreCase);
    }

    private static void NormalizarEstados(IEnumerable<OrdenCompraConsultaDTO> items)
    {
        foreach (var item in items)
        {
            item.Estado = NormalizarEstado(item.Estado);
        }
    }

    private static string? NormalizarEstado(string? estado)
    {
        if (string.IsNullOrWhiteSpace(estado))
        {
            return estado;
        }

        var valor = estado.Trim();

        if (valor.Equals("IN", StringComparison.OrdinalIgnoreCase))
        {
            return "INGRESADO";
        }

        if (valor.Equals("AN", StringComparison.OrdinalIgnoreCase))
        {
            return "ANULADO";
        }

        return valor;
    }

    private Task SeleccionarProveedor(ProveedorDTO p)
    {
        idProveedor = p.IdProveedor;
        nombreProveedor = p.Nombre;
        mostrarProveedorModal = false;
        _ = Task.WhenAll(Buscar(), BuscarPagos());
        return Task.CompletedTask;
    }

    private void LimpiarProveedor()
    {
        idProveedor = null;
        nombreProveedor = string.Empty;
        _ = Task.WhenAll(Buscar(), BuscarPagos());
    }

    private void PrevPageOc()
    {
        if (currentPageOc > 1) currentPageOc--;
    }

    private void NextPageOc()
    {
        if (currentPageOc < totalPagesOc) currentPageOc++;
    }

    private void PrevPagePagos()
    {
        if (currentPagePagos > 1) currentPagePagos--;
    }

    private void NextPagePagos()
    {
        if (currentPagePagos < totalPagesPagos) currentPagePagos++;
    }

    private void VerFotoPago(OrdenCompraConsultaDTO o)
    {
        if (!o.NumeroOc.StartsWith("PP-", StringComparison.OrdinalIgnoreCase))
            return;
        if (int.TryParse(o.NumeroOc[3..], out var idIe))
        {
            photoUrl = $"{Http.BaseAddress}api/IngresosEgresos/foto/{idIe}?t={DateTime.Now.Ticks}";
            showPhotoModal = true;
        }
    }

    private void ClosePhotoModal()
    {
        showPhotoModal = false;
        photoUrl = null;
    }
}